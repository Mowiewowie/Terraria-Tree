name: TerrariTree Automated Data Extraction

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: 3. Download Headless tModLoader
        run: |
          mkdir tmodloader
          cd tmodloader
          wget -q https://github.com/tModLoader/tModLoader/releases/latest/download/tModLoader.zip
          unzip -q tModLoader.zip

      - name: 4. Build Custom Extraction Mod (Legacy Method)
        run: |
          cd tmodloader
          
          # Clean old artifacts to trigger TML's automatic .csproj generation
          rm -f ../DataExporterMod/*.csproj
          
          # Compile using the exact pathing from the legacy script
          dotnet tModLoader.dll -server -build ../DataExporterMod
          
          # Use find to locate the output, just like the legacy script
          mkdir -p ~/.local/share/Terraria/tModLoader/Mods/
          find ../DataExporterMod/ -name "DataExporterMod.tmod" -exec cp {} ~/.local/share/Terraria/tModLoader/Mods/ \;
          
          echo '["DataExporterMod"]' > ~/.local/share/Terraria/tModLoader/Mods/enabled.json

      - name: 5. Execute C# Memory Extraction (Config File Method)
        run: |
          cd tmodloader
          
          # Re-implement the legacy serverconfig.txt to permanently kill interactive prompts
          echo "autocreate=2" > serverconfig.txt
          echo "worldname=ExportWorld" >> serverconfig.txt
          echo "language=en-US" >> serverconfig.txt
          
          # Boot the server using the config file
          dotnet tModLoader.dll -server -config serverconfig.txt || true

      - name: 6. Move C# JSON Artifacts & Inject Wiki Data
        run: |
          # Extract the JSON using find, matching legacy behavior
          find ~/.local/share/Terraria/ -name "Terraria_Vanilla_*_Export.json" -exec cp {} ./Terraria_Vanilla_1.4.4_Export.json \;
          
          pip install requests beautifulsoup4
          python scripts/wiki-injector.py

      - name: 7. Commit & Push Final Databases
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Terraria_Vanilla_1.4.4_Export.json
          git commit -m "[CI/CD] Automated Terraria Database Update" || echo "No changes to commit"
          git push